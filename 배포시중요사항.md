# ğŸš€ Logbase Website ë°°í¬ ê°€ì´ë“œ

## ğŸ“ **ì¤‘ìš”í•œ íŒŒì¼ êµ¬ì¡°**

```
logbase-website/
â”œâ”€â”€ functions/                    # Firebase Functions ì†ŒìŠ¤
â”‚   â”œâ”€â”€ index.js                 # ğŸ”¥ í•µì‹¬ - Functions ì—”íŠ¸ë¦¬í¬ì¸íŠ¸
â”‚   â”œâ”€â”€ package.json             # Functions ì˜ì¡´ì„±
â”‚   â”œâ”€â”€ .next/                   # Next.js ë¹Œë“œ ê²°ê³¼ë¬¼ (ë³µì‚¬ë¨)
â”‚   â”œâ”€â”€ src/                     # ì†ŒìŠ¤ì½”ë“œ (ë³µì‚¬ë¨)
â”‚   â”œâ”€â”€ next.config.js           # Next.js ì„¤ì • (ë³µì‚¬ë¨)
â”‚   â””â”€â”€ tsconfig.json            # TypeScript ì„¤ì • (ë³µì‚¬ë¨)
â”œâ”€â”€ src/                         # ì›ë³¸ ì†ŒìŠ¤ì½”ë“œ
â”œâ”€â”€ next.config.js               # ğŸ”¥ í•µì‹¬ - output: 'standalone'
â”œâ”€â”€ firebase.json                # ğŸ”¥ í•µì‹¬ - Firebase ì„¤ì •
â””â”€â”€ .next/                       # ë¹Œë“œ ê²°ê³¼ë¬¼ (ì›ë³¸)
```

## ğŸ”§ **ë¹Œë“œ í”„ë¡œì„¸ìŠ¤**

### 1ï¸âƒ£ **ë©”ì¸ ë¹Œë“œ (í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ)**

````bash
cd C:\00.PROJECT\NEXTJS\logbase-website
npm run build

í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í„°ë¦¬ì—ì„œ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
# ë¹„ìš© ìµœì í™” ë°°í¬ (ê¶Œì¥)
npm run deploy:optimized

- âœ… `output: 'standalone'` ì„¤ì •ìœ¼ë¡œ ë¹Œë“œ
- âœ… `.next/standalone/` ë””ë ‰í† ë¦¬ ìƒì„±ë¨

### 2ï¸âƒ£ **Functions ë””ë ‰í† ë¦¬ë¡œ íŒŒì¼ ë³µì‚¬**

```bash
# .next ë””ë ‰í† ë¦¬ ë³µì‚¬
Remove-Item -Recurse -Force functions/.next -ErrorAction SilentlyContinue
Copy-Item -Recurse .next functions/

# ì†ŒìŠ¤ì½”ë“œ ë³µì‚¬
Remove-Item -Recurse -Force functions/src -ErrorAction SilentlyContinue
Copy-Item -Recurse src functions/

# ì„¤ì • íŒŒì¼ ë³µì‚¬
Copy-Item next.config.js functions/ -Force
Copy-Item tsconfig.json functions/ -Force
````

### 3ï¸âƒ£ **Functions ì˜ì¡´ì„± í™•ì¸**

```bash
cd functions
npm install next # Next.js íŒ¨í‚¤ì§€ í•„ìˆ˜
cd ..
ì´ ëª…ë ¹ì–´ëŠ” ë‹¤ìŒ ê³¼ì •ì„ ìë™ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤.
1. ë¹Œë“œ: Next.js ì•±ì„ standalone ëª¨ë“œë¡œ ë¹Œë“œ (npm run build)
2. ì¤€ë¹„: ë¹Œë“œ ê²°ê³¼ë¬¼ê³¼ public í´ë”ë¥¼ functions í´ë”ë¡œ ë³µì‚¬ (npm run prepare-deploy)
3. ì •ë¦¬: 30ì¼ ì´ìƒ ëœ ì˜¤ë˜ëœ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì—¬ ë¹„ìš© ì ˆê° (npm run cleanup)
4. ë°°í¬: Functionsì™€ Hostingì„ Firebaseì— ë°°í¬ (npm run deploy:functions & npm run deploy:hosting)
```

## ğŸ”¥ **í•µì‹¬ ì„¤ì • íŒŒì¼ë“¤**

### **1. `next.config.js`**

```javascript
const nextConfig = {
  output: "standalone", // ğŸ”¥ í•„ìˆ˜! Firebase Functionsìš©
  eslint: { ignoreDuringBuilds: true },
  typescript: { ignoreBuildErrors: true },
};
```

### **2. `functions/index.js`**

```javascript
// ğŸ”¥ ë¦¬ì „ ì„¤ì • í•„ìˆ˜
exports.nextjsFunc = onRequest(
  {
    region: "asia-northeast3", // í•œêµ­ ë¦¬ì „
    timeoutSeconds: 540,
    memory: "2GiB",
  },
  async (req, res) => {
    // Next.js ì•± ì´ˆê¸°í™” ë° ìš”ì²­ ì²˜ë¦¬
  }
);
```

### **3. `firebase.json`**

```json
{
  "functions": [
    {
      "source": "functions", // Functions ì†ŒìŠ¤ ìœ„ì¹˜
      "runtime": "nodejs20"
    }
  ],
  "hosting": {
    "rewrites": [
      {
        "source": "**",
        "function": {
          "functionId": "nextjsFunc",
          "region": "asia-northeast3" // ğŸ”¥ ë¦¬ì „ ì¼ì¹˜ í•„ìˆ˜
        }
      }
    ]
  }
}
```

## ğŸ—„ï¸ **Firebase Storage í™˜ê²½ ì„¤ì •**

### **Storage Bucket ìë™ ì„ íƒ ë©”ì»¤ë‹ˆì¦˜**

`src/lib/firebase-admin.ts` ì´ˆê¸°í™” ì‹œ í™˜ê²½ì— ë”°ë¼ ìë™ìœ¼ë¡œ ì˜¬ë°”ë¥¸ ë²„í‚·ì„ ì„ íƒí•©ë‹ˆë‹¤:

```typescript
// Storage Bucket ì´ë¦„ì„ í™˜ê²½ì— ë”°ë¼ ê²°ì •
const storageBucket = process.env.FIREBASE_STORAGE_EMULATOR_HOST
  ? "logbase-blog-83db6.appspot.com" // Emulator (ë¡œì»¬)
  : "logbase-blog-83db6.firebasestorage.app"; // Production (ì„œë²„)

return admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  storageBucket, // í™˜ê²½ë³„ ìë™ ì„ íƒ
});
```

### **Storage ì‚¬ìš© ë°©ë²•**

#### **âœ… ì˜¬ë°”ë¥¸ ì‚¬ìš©ë²•**

```typescript
import { adminBucket } from "@/lib/firebase-admin";

// íŒŒì¼ ì ‘ê·¼
const file = adminBucket.file("newsletters/example.html");
const [exists] = await file.exists();
```

#### **âŒ ì˜ëª»ëœ ì‚¬ìš©ë²•**

```typescript
// âŒ adminStorage.file() ì§ì ‘ í˜¸ì¶œ ë¶ˆê°€
import { adminStorage } from "@/lib/firebase-admin";
const file = adminStorage.file("path"); // TypeError: file is not a function

// âŒ bucket() ì¤‘ë³µ í˜¸ì¶œ ë¶ˆí•„ìš”
const bucket = adminStorage.bucket("logbase-blog-83db6.appspot.com");
const file = bucket.file("path"); // í™˜ê²½ë³„ ë¶„ê¸°ê°€ ì•ˆë¨
```

### **í™˜ê²½ë³„ ë™ì‘ ë°©ì‹**

| í™˜ê²½         | í™˜ê²½ ë³€ìˆ˜                                       | Bucket ì´ë¦„                              | ë™ì‘              |
| ------------ | ----------------------------------------------- | ---------------------------------------- | ----------------- |
| **ë¡œì»¬**     | `FIREBASE_STORAGE_EMULATOR_HOST=127.0.0.1:9199` | `logbase-blog-83db6.appspot.com`         | Emulator ì‚¬ìš©     |
| **í”„ë¡œë•ì…˜** | `FIREBASE_STORAGE_EMULATOR_HOST` ì—†ìŒ           | `logbase-blog-83db6.firebasestorage.app` | ì‹¤ì œ Storage ì‚¬ìš© |

### **í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬**

#### **ë¡œì»¬ ê°œë°œ (.env.local)**

```bash
# Firebase Admin ì¸ì¦ (ë¡œì»¬ ì „ìš©)
FIREBASE_ADMIN_PROJECT_ID=logbase-blog-83db6
FIREBASE_ADMIN_PRIVATE_KEY=-----BEGIN PRIVATE KEY-----...
FIREBASE_ADMIN_CLIENT_EMAIL=firebase-adminsdk-...@logbase-blog-83db6.iam.gserviceaccount.com

# Emulator ì‹¤í–‰ ì‹œ ìë™ ì„¤ì • (npm run dev ë˜ëŠ” npm run emulators)
FIREBASE_STORAGE_EMULATOR_HOST=127.0.0.1:9199
FIRESTORE_EMULATOR_HOST=127.0.0.1:8081
```

#### **í”„ë¡œë•ì…˜ (Firebase Functions)**

- `.env.local` íŒŒì¼ì€ **ë°°í¬ë˜ì§€ ì•ŠìŒ** (Git ì œì™¸)
- Firebase FunctionsëŠ” **Application Default Credentials** ìë™ ì‚¬ìš©
- `firebase.json`ì˜ `environmentVariables`ì— í•„ìš”í•œ í™˜ê²½ ë³€ìˆ˜ë§Œ ì •ì˜:

```json
{
  "functions": [
    {
      "environmentVariables": {
        "SLACK_MONITORING_WEBHOOK_URL": "https://...",
        "SLACK_INQUIRY_WEBHOOK_URL": "https://...",
        "SLACK_NEWSLETTER_WEBHOOK_URL": "https://..."
      }
    }
  ]
}
```

### **Storage ê´€ë ¨ API íŒŒì¼ë“¤**

ëª¨ë“  Storage ê´€ë ¨ APIì—ì„œ `adminBucket`ì„ ì‚¬ìš©í•˜ë„ë¡ í†µì¼ë¨:

- âœ… `newsletter-get/[filename].ts`
- âœ… `newsletter-send.ts`
- âœ… `newsletter-list.ts`
- âœ… `newsletter-delete.ts`
- âœ… `newsletter-create.ts`
- âœ… `newsletter-update/[filename].ts`
- âœ… `newsletter-preview/[filename].ts`
- âœ… `rss-migrate/delete.ts`
- âœ… `blog/[guid].ts`
- âœ… `blog/create.ts`

## âš ï¸ **ë°°í¬ì‹œ ì£¼ì˜ì‚¬í•­**

### **ğŸ–¥ï¸ OS í™˜ê²½ë³„ ì£¼ì˜ì‚¬í•­**

- **Windows PowerShell ì‚¬ìš©ì**: `&&` ëŒ€ì‹  `;` ì‚¬ìš©

  ```powershell
  # âŒ ì˜ëª»ëœ ì˜ˆì‹œ
  cd logbase-website && npm run build

  # âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ
  cd logbase-website; npm run build
  ```

### **ğŸ–¥ï¸ ë°°í¬ ì „ í™˜ê²½ í™•ì¸**

- **ë¡œì»¬ ê°œë°œì„œë²„ í™•ì¸ ë° ì¤‘ì§€**:

  ```powershell
  # ê°œë°œì„œë²„ í”„ë¡œì„¸ìŠ¤ í™•ì¸
  Get-Process | Where-Object {$_.ProcessName -like "*node*" -and $_.CommandLine -like "*next*"}

  # ê°œë°œì„œë²„ ì¤‘ì§€ (í¬íŠ¸ 3000 ì‚¬ìš© í”„ë¡œì„¸ìŠ¤)
  Get-Process | Where-Object {$_.ProcessName -like "*node*"} | Stop-Process -Force

  # ë˜ëŠ” íŠ¹ì • í¬íŠ¸ ì‚¬ìš© í”„ë¡œì„¸ìŠ¤ í™•ì¸ ë° ì¤‘ì§€
  netstat -ano | findstr :3000
  # ìœ„ ëª…ë ¹ì–´ë¡œ ë‚˜ì˜¨ PIDë¡œ í”„ë¡œì„¸ìŠ¤ ì¤‘ì§€
  # Stop-Process -Id <PID> -Force
  ```

### **DO âœ…**

1. **ë°°í¬ ì „ ë¡œì»¬ ê°œë°œì„œë²„ ì¤‘ì§€**: í¬íŠ¸ ì¶©ëŒ ë°©ì§€
2. **ë¹Œë“œëŠ” í•­ìƒ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ**: `logbase-website/`
3. **ë¦¬ì „ ì¼ì¹˜**: `firebase.json`ê³¼ `functions/index.js` ëª¨ë‘ `asia-northeast3`
4. **íŒŒì¼ ë³µì‚¬ ìˆœì„œ**: ë¹Œë“œ â†’ íŒŒì¼ë³µì‚¬ â†’ ë°°í¬
5. **next íŒ¨í‚¤ì§€**: `functions/package.json`ì— í¬í•¨ í•„ìˆ˜
6. **standalone ëª¨ë“œ**: `output: 'standalone'` ì„¤ì •
7. **PowerShell ëª…ë ¹ì–´**: `&&` ëŒ€ì‹  `;` ì‚¬ìš©
8. **newsletters.json ë¡œì»¬ ì „ìš©**: ë°°í¬ ì‹œ ì œì™¸
9. **Storage ì‚¬ìš©**: `adminBucket` ì‚¬ìš© (í™˜ê²½ë³„ ìë™ ì„ íƒ)
10. **í™˜ê²½ ë³€ìˆ˜**: `.env.local`ì€ ë¡œì»¬ ì „ìš©, í”„ë¡œë•ì…˜ì€ ADC ì‚¬ìš©

### **DON'T âŒ**

1. ~~ë¡œì»¬ ê°œë°œì„œë²„ ì‹¤í–‰ ìƒíƒœì—ì„œ ë°°í¬~~
2. ~~`functions` ë””ë ‰í† ë¦¬ì—ì„œ ë¹Œë“œí•˜ì§€ ë§ ê²ƒ~~
3. ~~ë¦¬ì „ ë¶ˆì¼ì¹˜ (us-central1 vs asia-northeast3)~~
4. ~~standalone ì„œë²„ ì§ì ‘ ì‹¤í–‰ (í¬íŠ¸ ì¶©ëŒ)~~
5. ~~`getRequestHandler()` ì—†ì´ ë°°í¬~~
6. ~~Windows PowerShellì—ì„œ `&&` ì‚¬ìš©~~
7. ~~newsletters.jsonì„ functionsì— ë³µì‚¬~~
8. ~~`adminStorage.file()` ì§ì ‘ í˜¸ì¶œ (TypeError ë°œìƒ)~~
9. ~~`adminStorage.bucket(name)` ìˆ˜ë™ ì„ íƒ (í™˜ê²½ë³„ ë¶„ê¸° ì•ˆë¨)~~
10. ~~`.env.local` íŒŒì¼ì„ Gitì— ì»¤ë°‹~~

## ğŸš€ **ë°°í¬ ëª…ë ¹ì–´ ìˆœì„œ**

### **ì „ì²´ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ (PowerShell)**

```powershell
# 0. ë¡œì»¬ ê°œë°œì„œë²„ í™•ì¸ ë° ì¤‘ì§€
Get-Process | Where-Object {$_.ProcessName -like "*node*"} | Stop-Process -Force -ErrorAction SilentlyContinue

# 1. í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ ë¹Œë“œ
cd C:\00.PROJECT\NEXTJS\logbase-website
npm run build

# 2. íŒŒì¼ ë³µì‚¬
Remove-Item -Recurse -Force functions/.next -ErrorAction SilentlyContinue; Copy-Item -Recurse .next functions/
Remove-Item -Recurse -Force functions/src -ErrorAction SilentlyContinue; Copy-Item -Recurse src functions/
Copy-Item next.config.js functions/ -Force; Copy-Item tsconfig.json functions/ -Force
# newsletters.jsonì€ ë¡œì»¬ì—ì„œë§Œ ì‚¬ìš©í•˜ë¯€ë¡œ ì œì™¸
# Copy-Item -Recurse public functions/ -Force

# 3. Functions ì˜ì¡´ì„± í™•ì¸
cd functions; npm install next; cd ..

# 4. ë°°í¬
firebase deploy --only functions
```

### **ğŸ’° ë¹„ìš© ìµœì í™” ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ (ê¶Œì¥)**

```powershell
# 0. ë¡œì»¬ ê°œë°œì„œë²„ í™•ì¸ ë° ì¤‘ì§€
Get-Process | Where-Object {$_.ProcessName -like "*node*"} | Stop-Process -Force -ErrorAction SilentlyContinue

# 1. í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ ë¹Œë“œ
cd C:\00.PROJECT\NEXTJS\logbase-website
npm run build

# 2. íŒŒì¼ ë³µì‚¬
Remove-Item -Recurse -Force functions/.next -ErrorAction SilentlyContinue; Copy-Item -Recurse .next functions/
Remove-Item -Recurse -Force functions/src -ErrorAction SilentlyContinue; Copy-Item -Recurse src functions/
Copy-Item next.config.js functions/ -Force; Copy-Item tsconfig.json functions/ -Force

# 3. Functions ì˜ì¡´ì„± í™•ì¸
cd functions; npm install next; cd ..

# 4. ì˜¤ë˜ëœ Container Registry ì´ë¯¸ì§€ ì •ë¦¬ (ë¹„ìš© ì ˆê°)
npm run cleanup

# 5. ìµœì í™”ëœ ë°°í¬
npm run deploy:optimized
```

### **ë‹¨ê³„ë³„ ì‹¤í–‰**

```bash
# 0ë‹¨ê³„: ë¡œì»¬ ê°œë°œì„œë²„ í™•ì¸ ë° ì¤‘ì§€
Get-Process | Where-Object {$_.ProcessName -like "*node*"} | Stop-Process -Force -ErrorAction SilentlyContinue

# 1ë‹¨ê³„: ë¹Œë“œ
npm run build

# 2ë‹¨ê³„: íŒŒì¼ ë³µì‚¬
Remove-Item -Recurse -Force functions/.next -ErrorAction SilentlyContinue
Copy-Item -Recurse .next functions/
Remove-Item -Recurse -Force functions/src -ErrorAction SilentlyContinue
Copy-Item -Recurse src functions/
Copy-Item next.config.js functions/ -Force
Copy-Item tsconfig.json functions/ -Force
# newsletters.jsonì€ ë¡œì»¬ì—ì„œë§Œ ì‚¬ìš©í•˜ë¯€ë¡œ ì œì™¸
# Copy-Item -Recurse public functions/ -Force

# 3ë‹¨ê³„: ì˜ì¡´ì„± ì„¤ì¹˜
cd functions
npm install next
cd ..

# 4ë‹¨ê³„: ë°°í¬
firebase deploy --only functions
```

## ğŸ¯ **ì„±ê³µ ì§€í‘œ**

### **ë°°í¬ ì„±ê³µì‹œ ì¶œë ¥**

```
âœ… functions[nextjsFunc(asia-northeast3)] Successful create operation.
âœ… functions[nextjsfunc(asia-northeast3)]: Successful create operation.
âœ… Function URL: https://asia-northeast3-logbase-blog-83db6.cloudfunctions.net/nextjsFunc
```

### **ë¡œê·¸ì—ì„œ í™•ì¸í•´ì•¼ í•  ë‚´ìš©**

```
ğŸ”§ Next.js ì•± ì¤€ë¹„ ì¤‘...
âœ… Next.js ì•± ì´ˆê¸°í™” ì™„ë£Œ
ğŸ”§ Next.jsë¡œ ìš”ì²­ ì „ë‹¬
```

### **ë¡œê·¸ í™•ì¸ ëª…ë ¹ì–´**

```bash
firebase functions:log --only nextjsFunc
```

## ğŸ› **íŠ¸ëŸ¬ë¸”ìŠˆíŒ…**

### **ìì£¼ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜ë“¤**

1. **`req.on is not a function`**

   - ì›ì¸: standalone ì„œë²„ ì§ì ‘ ì‹¤í–‰
   - í•´ê²°: `getRequestHandler()` ì‚¬ìš©

2. **`EADDRINUSE: address already in use`**

   - ì›ì¸: í¬íŠ¸ 8080 ì¶©ëŒ
   - í•´ê²°: standalone ì„œë²„ ëŒ€ì‹  Next.js ì•± ê°ì²´ ì‚¬ìš©

3. **ë¦¬ì „ ë¶ˆì¼ì¹˜ ì˜¤ë¥˜**

   - ì›ì¸: `firebase.json`ê³¼ `functions/index.js` ë¦¬ì „ ë‹¤ë¦„
   - í•´ê²°: ëª¨ë‘ `asia-northeast3`ë¡œ í†µì¼

4. **ë¹Œë“œ íŒŒì¼ ì—†ìŒ**

   - ì›ì¸: í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ ë¹Œë“œ ì•ˆí•¨
   - í•´ê²°: `logbase-website/`ì—ì„œ `npm run build`

5. **PowerShell ëª…ë ¹ì–´ ì˜¤ë¥˜**

   - ì›ì¸: `&&` ì‚¬ìš© (Windows PowerShellì—ì„œ ì§€ì› ì•ˆí•¨)
   - í•´ê²°: `;` ì‚¬ìš©

6. **í¬íŠ¸ ì¶©ëŒ ì˜¤ë¥˜**

   - ì›ì¸: ë¡œì»¬ ê°œë°œì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì¸ ìƒíƒœì—ì„œ ë°°í¬
   - í•´ê²°: ë°°í¬ ì „ `Get-Process | Where-Object {$_.ProcessName -like "*node*"} | Stop-Process -Force` ì‹¤í–‰

7. **Container Registry ë¹„ìš© ê³¼ë‹¤ ë°œìƒ**

   - ì›ì¸: Vulnerability Scanning ìë™ í™œì„±í™”, ì˜¤ë˜ëœ ì´ë¯¸ì§€ ëˆ„ì 
   - í•´ê²°: GCP Consoleì—ì„œ Vulnerability Scanning ë¹„í™œì„±í™”, `npm run cleanup` ì •ê¸° ì‹¤í–‰

8. **`TypeError: adminStorage.file is not a function`**

   - ì›ì¸: `adminStorage.file()` ì§ì ‘ í˜¸ì¶œ (ì˜ëª»ëœ ì‚¬ìš©ë²•)
   - í•´ê²°: `adminBucket.file()` ì‚¬ìš©

   ```typescript
   // âŒ ì˜ëª»ëœ ì‚¬ìš©
   import { adminStorage } from "@/lib/firebase-admin";
   const file = adminStorage.file("path");

   // âœ… ì˜¬ë°”ë¥¸ ì‚¬ìš©
   import { adminBucket } from "@/lib/firebase-admin";
   const file = adminBucket.file("path");
   ```

9. **Storage Bucket í™˜ê²½ë³„ ì˜¤ë¥˜**
   - ì›ì¸: ë¡œì»¬/í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ì˜ëª»ëœ ë²„í‚· ì ‘ê·¼
   - í•´ê²°: `firebase-admin.ts`ì—ì„œ ìë™ ì„ íƒë˜ë„ë¡ ì„¤ì •ë¨ (ìˆ˜ë™ ì„ íƒ ë¶ˆí•„ìš”)
   - í™•ì¸: `FIREBASE_STORAGE_EMULATOR_HOST` í™˜ê²½ ë³€ìˆ˜ë¡œ ìë™ ë¶„ê¸°

## ğŸ“ **ì²´í¬ë¦¬ìŠ¤íŠ¸**

### **ë°°í¬ ì „ í™•ì¸ì‚¬í•­**

- [ ] ë¡œì»¬ ê°œë°œì„œë²„ ì¤‘ì§€ í™•ì¸
- [ ] í”„ë¡œì íŠ¸ ë£¨íŠ¸ì—ì„œ `npm run build` ì‹¤í–‰
- [ ] `.next/standalone/` ë””ë ‰í† ë¦¬ ì¡´ì¬ í™•ì¸
- [ ] `functions/.next/` ë³µì‚¬ ì™„ë£Œ
- [ ] `functions/src/` ë³µì‚¬ ì™„ë£Œ
- [ ] `functions/next.config.js` ë³µì‚¬ ì™„ë£Œ
- [ ] `functions/package.json`ì— `next` íŒ¨í‚¤ì§€ í¬í•¨
- [ ] `firebase.json`ê³¼ `functions/index.js` ë¦¬ì „ ì¼ì¹˜
- [ ] `firebase deploy --only functions` ì‹¤í–‰
- [ ] newsletters.jsonì€ ë¡œì»¬ì—ì„œë§Œ ì‚¬ìš© (ë°°í¬ ì œì™¸)
- [ ] **Firebase Storage**: ëª¨ë“  APIì—ì„œ `adminBucket` ì‚¬ìš© í™•ì¸
- [ ] **í™˜ê²½ ë³€ìˆ˜**: `.env.local` Git ì œì™¸ í™•ì¸ (.gitignore)
- [ ] **Storage Bucket**: firebase-admin.tsì—ì„œ í™˜ê²½ë³„ ìë™ ì„ íƒ í™•ì¸

### **ğŸ’° ë¹„ìš© ìµœì í™” í™•ì¸ì‚¬í•­**

- [ ] GCP Consoleì—ì„œ Vulnerability Scanning ë¹„í™œì„±í™” í™•ì¸
- [ ] `npm run cleanup`ìœ¼ë¡œ ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬
- [ ] `npm run deploy:optimized` ì‚¬ìš© (ë¹„ìš© ìµœì í™” ë°°í¬)
- [ ] Container Registry ì´ë¯¸ì§€ í¬ê¸° ëª¨ë‹ˆí„°ë§
- [ ] ì›” 1íšŒ ì´ë¯¸ì§€ ì •ë¦¬ ìŠ¤ì¼€ì¤„ í™•ì¸

### **ğŸ”§ Digest ì¬ì‚¬ìš© ìµœì í™” í™•ì¸ì‚¬í•­**

- [ ] `npm run digest:monitor`ë¡œ ì¬ì‚¬ìš©ë¥  ë¶„ì„
- [ ] ì˜ì¡´ì„± ë²„ì „ ê³ ì • í™•ì¸ (^ ì œê±°)
- [ ] ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œ ì‚¬ìš©
- [ ] .dockerignore ìµœì í™”
- [ ] ë ˆì´ì–´ ìˆœì„œ ìµœì í™”

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-11-04
**ì£¼ìš” ë³€ê²½ì‚¬í•­**: Firebase Storage adminBucket í†µì¼, í™˜ê²½ë³„ ìë™ ì„ íƒ ì¶”ê°€
**ë°°í¬ í™˜ê²½**: Windows PowerShell
**ë¦¬ì „**: asia-northeast3
**Next.js ë²„ì „**: 14.2.32
**Node.js ë²„ì „**: 20

---

## ğŸ’° **Container Registry ë¹„ìš© ìµœì í™”**

### **ğŸ”§ ë¹„ìš© ìµœì í™” ì„¤ì •**

#### **1. firebase.json ìµœì í™”**

```json
{
  "functions": [
    {
      "source": "functions",
      "codebase": "default",
      "runtime": "nodejs20",
      "memory": "512MB",
      "timeoutSeconds": 300,
      "maxInstances": 5,
      "ignore": [
        "node_modules",
        ".git",
        "firebase-debug.log",
        "firebase-debug.*.log",
        "*.local",
        ".next",
        "src",
        "test-*.js"
      ]
    }
  ]
}
```

#### **2. next.config.js ìµœì í™”**

```javascript
const nextConfig = {
  output: "standalone",
  eslint: { ignoreDuringBuilds: true },
  typescript: { ignoreBuildErrors: true },
  experimental: {
    optimizeCss: true,
    optimizePackageImports: ["@google-cloud/secret-manager"],
  },
  webpack: (config, { isServer }) => {
    if (!isServer) {
      config.resolve.fallback = {
        fs: false,
        net: false,
        tls: false,
      };
    }
    return config;
  },
};
```

### **ğŸ§¹ ì´ë¯¸ì§€ ì •ë¦¬ ìŠ¤í¬ë¦½íŠ¸**

#### **ìë™ ì •ë¦¬ ëª…ë ¹ì–´**

```bash
# 30ì¼ ì´ìƒ ëœ ì´ë¯¸ì§€ ì •ë¦¬
npm run cleanup

# ìˆ˜ë™ ì •ë¦¬ (í•„ìš”ì‹œ)
npm run cleanup:manual
```

#### **ì •ê¸° ì •ë¦¬ ìŠ¤ì¼€ì¤„ (ê¶Œì¥)**

- **ì£¼ê¸°**: ì›” 1íšŒ
- **ëª…ë ¹ì–´**: `npm run cleanup`
- **ëª©ì **: Container Registry ë¹„ìš© ì ˆê°

### **ğŸ“Š ë¹„ìš© ëª¨ë‹ˆí„°ë§**

#### **GCP Billing Alert ì„¤ì •**

1. GCP Console â†’ Billing
2. Budgets & alerts â†’ Create budget
3. ì˜ˆì‚° ê¸ˆì•¡: ì›” $30
4. Alert ì„ê³„ê°’: 50%, 80%, 100%

#### **Container Registry ì‚¬ìš©ëŸ‰ í™•ì¸**

```bash
# ì´ë¯¸ì§€ ëª©ë¡ ë° í¬ê¸° í™•ì¸
gcloud container images list-tags gcr.io/logbase-website/nextjs --format="table(timestamp,digest,size)"

# ì˜¤ë˜ëœ ì´ë¯¸ì§€ í™•ì¸
gcloud container images list-tags gcr.io/logbase-website/nextjs --filter="timestamp.datetime<2024-01-01"
```

### **ğŸš¨ ì¦‰ì‹œ ì¡°ì¹˜ ì‚¬í•­**

#### **Vulnerability Scanning ë¹„í™œì„±í™”**

1. GCP Console ì ‘ì†
2. Container Registry â†’ Settings
3. "Vulnerability scanning" ì²´í¬ í•´ì œ
4. Save í´ë¦­

#### **ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì‚­ì œ**

```bash
# 30ì¼ ì´ìƒ ëœ ì´ë¯¸ì§€ ì‚­ì œ
npm run cleanup

# ë˜ëŠ” ìˆ˜ë™ ì‚­ì œ
gcloud container images list-tags gcr.io/logbase-website/nextjs --filter="timestamp.datetime<2024-01-01" --format="value(digest)" | xargs -I {} gcloud container images delete gcr.io/logbase-website/nextjs@{} --quiet
```

### **ğŸ“ˆ ë¹„ìš© ì ˆê° íš¨ê³¼**

#### **ì˜ˆìƒ ì ˆê° íš¨ê³¼**

- **Vulnerability Scanning ë¹„í™œì„±í™”**: ì›” $50-100 ì ˆê°
- **ì •ê¸° ì´ë¯¸ì§€ ì •ë¦¬**: ì›” $10-20 ì ˆê°
- **Functions ìµœì í™”**: ì›” $5-15 ì ˆê°
- **ì´ ì˜ˆìƒ ì ˆê°**: ì›” $65-135

#### **ëª¨ë‹ˆí„°ë§ ì§€í‘œ**

- Container Registry Storage ì‚¬ìš©ëŸ‰
- Functions ì‹¤í–‰ ì‹œê°„ ë° ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
- ì›”ë³„ ì´ ë¹„ìš© ì¶”ì´

---

## ğŸ”§ **Digest ì¬ì‚¬ìš© ìµœì í™”**

### **ğŸ“Š Digest ì¬ì‚¬ìš© ì›ë¦¬**

#### **Docker Layer Caching**

```dockerfile
# ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œë¡œ digest ì¬ì‚¬ìš© ìµœì í™”
FROM node:18-alpine AS base
WORKDIR /app

# ì˜ì¡´ì„± ì„¤ì¹˜ ë ˆì´ì–´ (ìì£¼ ë³€ê²½ë˜ì§€ ì•ŠìŒ)
FROM base AS deps
COPY package.json package-lock.json* ./
RUN npm ci --only=production

# ë¹Œë“œ ë ˆì´ì–´ (ì†ŒìŠ¤ì½”ë“œ ë³€ê²½ì‹œì—ë§Œ ì¬ë¹Œë“œ)
FROM base AS builder
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build

# í”„ë¡œë•ì…˜ ë ˆì´ì–´ (ìµœì¢… ì´ë¯¸ì§€)
FROM base AS runner
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
```

### **ğŸ’° Digest ì¬ì‚¬ìš© íš¨ê³¼**

#### **ë¹„ìš© ì ˆê° íš¨ê³¼**

- **ë ˆì´ì–´ ì¬ì‚¬ìš©ë¥ **: 30-50% í–¥ìƒ
- **ë¹Œë“œ ì‹œê°„**: 40-60% ë‹¨ì¶•
- **ì €ì¥ ê³µê°„**: 20-30% ì ˆì•½
- **ì›” ì ˆê° ë¹„ìš©**: $10-20 ì¶”ê°€ ì ˆì•½

#### **ì„±ëŠ¥ í–¥ìƒ**

- **ë°°í¬ ì†ë„**: ë ˆì´ì–´ ìºì‹œë¡œ ì¸í•œ ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•
- **ë„¤íŠ¸ì›Œí¬ ì‚¬ìš©ëŸ‰**: ê¸°ì¡´ ë ˆì´ì–´ ì¬ì‚¬ìš©ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ ê°ì†Œ
- **ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì„±**: ë¶ˆí•„ìš”í•œ ì¬ë¹Œë“œ ë°©ì§€

### **ğŸ”§ ìµœì í™” ë„êµ¬**

#### **Digest ëª¨ë‹ˆí„°ë§**

```bash
# ì¬ì‚¬ìš©ë¥  ë¶„ì„
npm run digest:monitor

# ê²°ê³¼ ì˜ˆì‹œ:
ğŸ“Š Digest ì¬ì‚¬ìš© ë¶„ì„ ê²°ê³¼
==================================================
í˜„ì¬ Digest: sha256:abc123...
ë ˆì´ì–´ ì •ë³´: [ë ˆì´ì–´ë³„ í¬ê¸° ë° digest]
ğŸ’° ë¹„ìš© ì ˆê° íš¨ê³¼ ì¶”ì •:
- ì˜ˆìƒ ì¬ì‚¬ìš©ë¥ : 30%
- ì›” ì ˆê° ë¹„ìš©: $0.0156
- ì—° ì ˆê° ë¹„ìš©: $0.1872
```

#### **ìµœì í™”ëœ íŒŒì¼ë“¤**

- **Dockerfile.optimized**: ë©€í‹°ìŠ¤í…Œì´ì§€ ë¹Œë“œ
- **.dockerignore.optimized**: ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œì™¸
- **package.json**: ì˜ì¡´ì„± ë²„ì „ ê³ ì •

### **ğŸ“ˆ ëª¨ë‹ˆí„°ë§ ì§€í‘œ**

#### **Digest ì¬ì‚¬ìš©ë¥  ëª©í‘œ**

- **ë ˆì´ì–´ ì¬ì‚¬ìš©ë¥ **: 30-50%
- **ì´ë¯¸ì§€ í¬ê¸°**: 500MB ì´í•˜
- **ë¹Œë“œ ì‹œê°„**: 5ë¶„ ì´í•˜
- **ì›” ë¹„ìš©**: $30 ì´í•˜

#### **ì •ê¸° ì ê²€ í•­ëª©**

- [ ] ì›” 1íšŒ digest ì¬ì‚¬ìš©ë¥  ë¶„ì„
- [ ] ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ì‹œ ì¬ì‚¬ìš©ë¥  í™•ì¸
- [ ] ë¹Œë“œ ì‹œê°„ ëª¨ë‹ˆí„°ë§
- [ ] ì´ë¯¸ì§€ í¬ê¸° ì¶”ì 

### **ğŸš€ ê³ ê¸‰ ë°°í¬ ì›Œí¬í”Œë¡œìš°**

#### **ì™„ì „ ìµœì í™”ëœ ë°°í¬**

```powershell
# 1. ì‚¬ì „ ë¶„ì„
npm run digest:monitor

# 2. ìµœì í™”ëœ ë¹Œë“œ ë° ë°°í¬
npm run deploy:optimized

# 3. ë°°í¬ í›„ ë¶„ì„
npm run digest:monitor
```

#### **ì„±ëŠ¥ ë¹„êµ**

| ë°°í¬ ë°©ì‹     | ë¹Œë“œ ì‹œê°„ | ì´ë¯¸ì§€ í¬ê¸° | ì›” ë¹„ìš© |
| ------------- | --------- | ----------- | ------- |
| ê¸°ë³¸ ë°°í¬     | 8ë¶„       | 600MB       | $50     |
| ë¹„ìš© ìµœì í™”   | 6ë¶„       | 500MB       | $30     |
| Digest ìµœì í™” | 4ë¶„       | 400MB       | $20     |

#### functions ë””ë ‰í„°ë¦¬ì— í•„ìš”ì—†ëŠ” íŒŒì¼ ì‚­ì œ ìŠ¤í¬ë¦½íŠ¸

# functions/src ë””ë ‰í„°ë¦¬ ì‚­ì œ

Remove-Item -Recurse -Force -Path "functions/src" -ErrorAction SilentlyContinue

# functions/pages ë””ë ‰í„°ë¦¬ ì‚­ì œ

Remove-Item -Recurse -Force -Path "functions/pages" -ErrorAction SilentlyContinue

# functions/config.js íŒŒì¼ ì‚­ì œ

Remove-Item -Force -Path "functions/config.js" -ErrorAction SilentlyContinue

Write-Host "âœ… functions ë””ë ‰í„°ë¦¬ ì •ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
