"use strict";(()=>{var e={};e.id=530,e.ids=[530],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9648:e=>{e.exports=import("axios")},295:e=>{e.exports=import("cheerio")},3745:e=>{e.exports=import("firebase/app")},401:e=>{e.exports=import("firebase/auth")},1492:e=>{e.exports=import("firebase/firestore")},3292:e=>{e.exports=require("fs/promises")},1017:e=>{e.exports=require("path")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},9090:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{config:()=>p,default:()=>c,routeModule:()=>g});var n=r(1802),s=r(7153),a=r(6249),l=r(8729),i=e([l]);l=(i.then?(await i)():i)[0];let c=(0,a.l)(l,"default"),p=(0,a.l)(l,"config"),g=new n.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/newsletter-create",pathname:"/api/newsletter-create",bundlePath:"",filename:""},userland:l});o()}catch(e){o(e)}})},4810:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.d(t,{I:()=>p,db:()=>c});var n=r(3745),s=r(1492),a=r(401),l=e([n,s,a]);[n,s,a]=l.then?(await l)():l;let i=0===(0,n.getApps)().length?(0,n.initializeApp)({apiKey:"AIzaSyA6kCmSqaBH5SUPb4PkHU1hwe0l5Ppqw2w",authDomain:"logbase-blog-83db6.firebaseapp.com",projectId:"logbase-blog-83db6",storageBucket:"logbase-blog-83db6.firebasestorage.app",messagingSenderId:"938632982963",appId:"1:938632982963:web:6159f776e4466bf74bdbc6"}):(0,n.getApps)()[0],c=(0,s.getFirestore)(i),p=(0,a.getAuth)(i);o()}catch(e){o(e)}})},8729:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{default:()=>u});var n=r(3292),s=r.n(n),a=r(1017),l=r.n(a),i=r(4810),c=r(1492),p=r(9648),g=r(295),d=e([i,c,p,g]);async function u(e,t){if("POST"!==e.method)return t.status(405).json({message:"Method not allowed"});try{let r;let{title:o,content:n,url:a,sentDate:d,recipients:u}=e.body;if(console.log("--- Newsletter Generation Start ---"),console.log("[DATA RECEIVED] Request Body:",{title:o,content:n,sentDate:d,url:a,recipientsCount:u?.length}),!o?.trim()||!n?.trim()||!d)return t.status(400).json({success:!1,message:"제목, 내용, 발송일은 필수 항목입니다."});if(!u||0===u.length)return t.status(400).json({success:!1,message:"수신자를 한 명 이상 선택해주세요."});let m=l().resolve(process.cwd(),"public/news_letter_template.html");try{r=await s().readFile(m,"utf-8"),console.log("[TEMPLATE] Successfully loaded template file")}catch(e){return console.error("Template file not found:",m),t.status(500).json({success:!1,message:"템플릿 파일을 찾을 수 없습니다."})}let f=new Date(d).toLocaleDateString("ko-KR",{year:"numeric",month:"long",day:"numeric"});r=(r=(r=r.replace(/{{제목}}/g,o)).replace(/{{발송일}}/g,f)).replace(/{{본문 내용 들어가는 곳}}/g,n.replace(/\n/g,"<br>"));let w="";if(a){console.log("\n--- URL Crawling Section Start ---"),console.log(`[CRAWL_URL] Attempting to crawl: ${a}`);try{let{data:e}=await p.default.get(a,{timeout:5e3,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"}}),t=g.load(e),r=t('meta[property="og:image"]').attr("content")||t('meta[name="twitter:image"]').attr("content")||"",o=t('meta[property="og:title"]').attr("content")||t("title").text()||"",n=t('meta[property="og:description"]').attr("content")||t('meta[name="description"]').attr("content")||"";console.log(`[CRAWL_RESULT] Title: "${o}"`),console.log(`[CRAWL_RESULT] Description: "${n?n.substring(0,200)+"...":""}"`),console.log(`[CRAWL_RESULT] Image URL: "${r}"`),o?(w=`
      <!-- URL 인사이트 영역 시작 -->
      <tr>
        <td style="padding: 20px; background-color: #f8fafc; border-radius: 6px; margin: 20px 0;">
          <h3 style="font-size: 18px; color: #111; margin-bottom: 16px;">LOGBASE INSIGHT</h3>
          <div style="display: flex; align-items: flex-start; gap: 16px;">
            ${r?`<img src="${r}" alt="Insight Image" style="width: 200px; min-width: 120px; border-radius: 4px; object-fit: cover; display: block;" />`:""}
            <div style="flex: 1;">
              <h4 style="margin-top: 0; margin-bottom: 6px; color: #111;">${o}</h4>
              <p style="margin: 0; font-size: 14px; color: #444;">${n}</p>
            </div>
          </div>
        </td>
      </tr>
      <!-- URL 인사이트 영역 끝 -->`,console.log("[CRAWL_SUCCESS] URL insight section was generated with crawled data.")):console.log("[CRAWL_SKIP] No title found, so insight section will be empty.")}catch(t){let e=t instanceof Error?t.message:String(t);console.error("[CRAWL_ERROR] Failed to crawl URL:",e)}console.log("--- URL Crawling Section End ---")}else console.log("\n[CRAWL_SKIP] No URL provided, skipping crawl section.");r=r.replace("{{URL_INSIGHT_SECTION}}",w);let h="";console.log(`
[RSS SCAN] Fetching RSS items from Firestore for date: ${d}`);try{let e=(0,c.collection)(i.db,"rss_items"),t=(0,c.query)(e,(0,c.where)("news_letter_sent_date","==",d)),r=(await (0,c.getDocs)(t)).docs.map(e=>e.data());for(let e of(console.log(`[RSS SCAN] Found ${r.length} matching RSS items in Firestore.`),r)){let t=new Date(e.pubDate).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),r=e.author||e.creator||"Unknown";h+=`<li><a href="${e.link}" style="color:#0041C4; text-decoration:none;" target="_blank"><strong>${e.title}</strong></a><br>${r} — ${t}</li>`,console.log(`    [MATCH FOUND!] Title: ${e.title}, Author: ${r}`)}}catch(e){console.error("[ERROR] Error during Firestore RSS processing:",e),h="<li>Error loading blog posts from database.</li>"}h||(h="<li>No articles found for this date.</li>"),console.log("\n[HTML GENERATED] Final Blog List HTML:",h),r=r.replace("{{BEHAVIORAL_DATA_UPDATES}}",h);let S=`newsletter_${d}_${Date.now()}.html`,A=l().resolve(process.cwd(),"public/newsletters");await s().mkdir(A,{recursive:!0});let b=l().join(A,S),y=`/newsletters/${S}`;await s().writeFile(b,r,"utf-8"),console.log(`[SUCCESS] HTML file created at: ${y}`);let R=l().join(A,"newsletters.json"),E=l().join(process.cwd(),"functions","public","newsletters","newsletters.json"),x=[];try{let e=await s().readFile(R,"utf-8");x=JSON.parse(e),Array.isArray(x)||(x=[])}catch{x=[]}let L={title:o,content:n,url:a||"",sentDate:d,htmlFilePath:y,recipients:u,filename:S.replace(".html","")};x.push(L),await s().writeFile(R,JSON.stringify(x,null,2),"utf-8"),console.log("[SUCCESS] newsletters.json updated");try{await s().writeFile(E,JSON.stringify(x,null,2),"utf-8"),console.log("[newsletters] Firebase Functions 파일도 업데이트됨")}catch(e){console.warn("[newsletters] Firebase Functions 파일 업데이트 실패:",e)}return console.log("--- Newsletter Generation End ---\n"),t.status(200).json({success:!0,message:"뉴스레터가 성공적으로 생성되었습니다!",data:{filename:S.replace(".html",""),title:o,htmlUrl:y}})}catch(r){console.error("--- Newsletter Generation Failed ---"),console.error("[FATAL ERROR]",r);let e=r instanceof Error?r.message:"An unknown error occurred.";return t.status(500).json({success:!1,message:"뉴스레터 생성에 실패했습니다.",error:e})}}[i,c,p,g]=d.then?(await d)():d,o()}catch(e){o(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=9090);module.exports=r})();