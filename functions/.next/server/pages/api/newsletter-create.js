"use strict";(()=>{var e={};e.id=9530,e.ids=[9530],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},629:e=>{e.exports=require("fs/promises")},5315:e=>{e.exports=require("path")},9648:e=>{e.exports=import("axios")},295:e=>{e.exports=import("cheerio")},3745:e=>{e.exports=import("firebase/app")},401:e=>{e.exports=import("firebase/auth")},1492:e=>{e.exports=import("firebase/firestore")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,o){return o in t?t[o]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,o)):"function"==typeof t&&"default"===o?t:void 0}}})},9090:(e,t,o)=>{o.a(e,async(e,r)=>{try{o.r(t),o.d(t,{config:()=>E,default:()=>c,routeModule:()=>g});var s=o(1802),l=o(7153),n=o(6249),a=o(8729),i=e([a]);a=(i.then?(await i)():i)[0];let c=(0,n.l)(a,"default"),E=(0,n.l)(a,"config"),g=new s.PagesAPIRouteModule({definition:{kind:l.x.PAGES_API,page:"/api/newsletter-create",pathname:"/api/newsletter-create",bundlePath:"",filename:""},userland:a});r()}catch(e){r(e)}})},5980:(e,t,o)=>{o.d(t,{Hf:()=>n,iW:()=>l});let r=require("firebase-admin");var s=o.n(r);!function(){if(s().apps.length>0)return s().app();let e={projectId:process.env.FIREBASE_ADMIN_PROJECT_ID,privateKey:process.env.FIREBASE_ADMIN_PRIVATE_KEY?.replace(/\\n/g,"\n"),clientEmail:process.env.FIREBASE_ADMIN_CLIENT_EMAIL},t=process.env.FIREBASE_STORAGE_EMULATOR_HOST?"logbase-blog-83db6.appspot.com":"logbase-blog-83db6.firebasestorage.app";e.privateKey?s().initializeApp({credential:s().credential.cert(e),storageBucket:t}):(console.warn("Firebase Admin private key is not set. Using default credentials."),s().initializeApp({projectId:process.env.FIREBASE_ADMIN_PROJECT_ID||"logbase-blog-83db6",storageBucket:t}))}();let l=s().firestore(),n=s().storage().bucket(),a=process.env.FIRESTORE_EMULATOR_HOST,i=process.env.FIREBASE_STORAGE_EMULATOR_HOST;a&&(console.log(`✅ [Admin SDK] Firestore Emulator 연결: ${a}`),console.log("   환경 변수를 통해 자동 연결되었습니다.")),i&&(console.log(`✅ [Admin SDK] Storage Emulator 설정: ${i}`),console.log("   환경 변수를 통해 자동 연결되었습니다."))},4810:(e,t,o)=>{o.a(e,async(e,r)=>{try{o.d(t,{I:()=>g,db:()=>E,l:()=>c});var s=o(3745),l=o(1492),n=o(401),a=e([s,l,n]);[s,l,n]=a.then?(await a)():a;let i={apiKey:"AIzaSyA6kCmSqaBH5SUPb4PkHU1hwe0l5Ppqw2w",authDomain:"logbase-blog-83db6.firebaseapp.com",projectId:"logbase-blog-83db6",storageBucket:"logbase-blog-83db6.firebasestorage.app",messagingSenderId:"938632982963",appId:"1:938632982963:web:6159f776e4466bf74bdbc6"};if(!i.apiKey||!i.projectId)throw Error("Firebase 설정이 올바르지 않습니다. .env.local 파일에 NEXT_PUBLIC_FIREBASE_ 환경 변수를 확인해주세요.");let c=0===(0,s.getApps)().length?(0,s.initializeApp)(i):(0,s.getApps)()[0],E=(0,l.getFirestore)(c),g=(0,n.getAuth)(c);r()}catch(e){r(e)}})},8729:(e,t,o)=>{o.a(e,async(e,r)=>{try{o.r(t),o.d(t,{default:()=>R});var s=o(629),l=o.n(s),n=o(5315),a=o.n(n),i=o(4810),c=o(1492),E=o(9648),g=o(295),p=o(5980),d=e([i,c,E,g]);async function R(e,t){if("POST"!==e.method)return t.status(405).json({message:"Method not allowed"});try{let o;let{title:r,content:s,url:n,sentDate:d,recipients:R}=e.body;if(console.log("--- Newsletter Generation Start ---"),console.log("[DATA RECEIVED] Request Body:",{title:r,content:s,sentDate:d,url:n,recipientsCount:R?.length}),!r?.trim()||!s?.trim()||!d)return t.status(400).json({success:!1,message:"제목, 내용, 발송일은 필수 항목입니다."});if(!R||0===R.length)return t.status(400).json({success:!1,message:"수신자를 한 명 이상 선택해주세요."});let u=a().resolve(process.cwd(),"public/news_letter_template.html");try{o=await l().readFile(u,"utf-8"),console.log("[TEMPLATE] Successfully loaded template file")}catch(e){return console.error("Template file not found:",u),t.status(500).json({success:!1,message:"템플릿 파일을 찾을 수 없습니다."})}let S=new Date(d).toLocaleDateString("ko-KR",{year:"numeric",month:"long",day:"numeric"});o=(o=(o=o.replace(/{{title}}/g,r)).replace(/{{sent_date}}/g,S)).replace(/{{content}}/g,s.replace(/\n/g,"<br>"));let A="";if(n){console.log("\n--- URL Crawling Section Start ---"),console.log(`[CRAWL_URL] Attempting to crawl: ${n}`);try{let{data:e}=await E.default.get(n,{timeout:5e3,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"}}),t=g.load(e),o=t('meta[property="og:image"]').attr("content")||t('meta[name="twitter:image"]').attr("content")||"",r=t('meta[property="og:title"]').attr("content")||t("title").text()||"",s=t('meta[property="og:description"]').attr("content")||t('meta[name="description"]').attr("content")||"";console.log(`[CRAWL_RESULT] Title: "${r}"`),console.log(`[CRAWL_RESULT] Description: "${s?s.substring(0,200)+"...":""}"`),console.log(`[CRAWL_RESULT] Image URL: "${o}"`),r?(A=`
      <!-- URL 인사이트 영역 시작 -->
      <tr>
        <td style="padding: 20px; background-color: #f8fafc; border-radius: 6px; margin: 20px 0;">
          <h3 style="font-size: 18px; color: #111; margin-bottom: 16px;">LOGBASE INSIGHT</h3>
          <div style="display: flex; align-items: flex-start; gap: 16px;">
            ${o?`<img src="${o}" alt="Insight Image" style="width: 200px; min-width: 120px; border-radius: 4px; object-fit: cover; display: block;" />`:""}
            <div style="flex: 1;">
              <h4 style="margin-top: 0; margin-bottom: 6px; color: #111;">${r}</h4>
              <p style="margin: 0; font-size: 14px; color: #444;">${s}</p>
            </div>
          </div>
        </td>
      </tr>
      <!-- URL 인사이트 영역 끝 -->`,console.log("[CRAWL_SUCCESS] URL insight section was generated with crawled data.")):console.log("[CRAWL_SKIP] No title found, so insight section will be empty.")}catch(t){let e=t instanceof Error?t.message:String(t);console.error("[CRAWL_ERROR] Failed to crawl URL:",e)}console.log("--- URL Crawling Section End ---")}else console.log("\n[CRAWL_SKIP] No URL provided, skipping crawl section.");o=o.replace("{{URL_INSIGHT_SECTION}}",A);let T="";console.log(`
[RSS SCAN] Fetching RSS items from Firestore for date: ${d}`);try{let e=(0,c.collection)(i.db,"rss_items"),t=(0,c.query)(e,(0,c.where)("news_letter_sent_date","==",d)),o=(await (0,c.getDocs)(t)).docs.map(e=>e.data());for(let e of(console.log(`[RSS SCAN] Found ${o.length} matching RSS items in Firestore.`),o)){let t=new Date(e.pubDate).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}),o=e.author||e.creator||"Unknown";T+=`<li><a href="${e.link}" style="color:#0041C4; text-decoration:none;" target="_blank"><strong>${e.title}</strong></a><br>${o} — ${t}</li>`,console.log(`    [MATCH FOUND!] Title: ${e.title}, Author: ${o}`)}}catch(e){console.error("[ERROR] Error during Firestore RSS processing:",e),T="<li>Error loading blog posts from database.</li>"}T||(T="<li>No articles found for this date.</li>"),console.log("\n[HTML GENERATED] Final Blog List HTML:",T),o=o.replace("{{BEHAVIORAL_DATA_UPDATES}}",T);let m=`newsletter_${d}_${Date.now()}.html`,f=`newsletters/${m}`,h=p.Hf.file(f);console.log(`[STORAGE] Cloud Storage 업로드 시작: ${f}`),console.log(`[STORAGE] 파일 크기: ${o.length} bytes`);let C="https://logbase.kr";if(process.env.FIREBASE_CONFIG||process.env.FUNCTION_TARGET){let e=process.env.FIREBASE_FUNCTION_URL||process.env.VERCEL_URL;C=e&&e.includes("logbase.kr")?"https://logbase.kr":e&&e.includes("localhost")?"http://localhost:3000":"https://logbase.kr",console.log(`[CONFIG] Firebase Functions 환경 - 감지된 URL: ${e}, 사용할 baseUrl: ${C}`)}else C="http://localhost:3000",console.log(`[CONFIG] 로컬 환경 - baseUrl: ${C}`);let b=`${C}/api/newsletter-preview/${m.replace(".html","")}`;try{await h.save(o,{metadata:{contentType:"text/html",cacheControl:"public, max-age=3600"}}),console.log(`[SUCCESS] HTML file uploaded to Cloud Storage: ${f}`),console.log(`[SUCCESS] Preview URL generated: ${b}`)}catch(e){return console.error("[ERROR] Cloud Storage 업로드 실패:",e),console.error("[ERROR] 에러 상세:",{message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0,storagePath:f,fileSize:o.length}),t.status(500).json({success:!1,message:"뉴스레터 파일 업로드에 실패했습니다.",error:e instanceof Error?e.message:"알 수 없는 오류"})}let _=a().resolve(process.cwd(),"public/newsletters/newsletters.json"),I={title:r,content:s,url:n||"",sentDate:d,htmlFilePath:f,publicUrl:b,recipients:R,filename:m.replace(".html","")};try{if(process.env.FIREBASE_CONFIG||process.env.FUNCTION_TARGET){console.log("[NEWSLETTER-CREATE] Firebase Functions 환경에서 Cloud Storage 사용");try{let e=p.Hf.file("newsletters/newsletters.json");console.log("[NEWSLETTER-CREATE] Cloud Storage 파일 객체 생성 완료");let t=[],[o]=await e.exists();if(console.log(`[NEWSLETTER-CREATE] 기존 newsletters.json 존재 여부: ${o}`),o){console.log("[NEWSLETTER-CREATE] 기존 파일 다운로드 시작...");let[o]=await e.download(),r=o.toString("utf-8");t=JSON.parse(r),Array.isArray(t)||(t=[]),console.log(`[NEWSLETTER-CREATE] 기존 뉴스레터 ${t.length}개 로드`)}else console.log("[NEWSLETTER-CREATE] 기존 파일이 없어서 새로 생성");t.push(I),console.log(`[NEWSLETTER-CREATE] 새 뉴스레터 추가 완료. 총 ${t.length}개`),console.log("[NEWSLETTER-CREATE] Cloud Storage에 저장 시작...");let r=JSON.stringify(t,null,2);console.log(`[NEWSLETTER-CREATE] 저장할 데이터 크기: ${r.length} bytes`),await e.save(r,{metadata:{contentType:"application/json"}}),console.log(`[NEWSLETTER-CREATE] Cloud Storage newsletters.json 업데이트 완료`)}catch(e){console.error("[NEWSLETTER-CREATE] Cloud Storage 업데이트 실패:",e),console.error("[NEWSLETTER-CREATE] 에러 상세:",{message:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0})}}else{console.log("[NEWSLETTER-CREATE] 로컬 환경에서 로컬 파일 사용");let e=[];try{let t=await l().readFile(_,"utf-8");e=JSON.parse(t),Array.isArray(e)||(e=[])}catch{e=[]}e.push(I),await l().writeFile(_,JSON.stringify(e,null,2),"utf-8"),console.log(`[NEWSLETTER-CREATE] 로컬 newsletters.json 업데이트 완료`)}}catch(e){console.error("[NEWSLETTER-CREATE] newsletters.json 업데이트 실패:",e)}return console.log("--- Newsletter Generation End ---\n"),t.status(200).json({success:!0,message:"뉴스레터가 성공적으로 생성되었습니다!",data:{filename:m.replace(".html",""),title:r,htmlUrl:n,storagePath:f}})}catch(o){console.error("--- Newsletter Generation Failed ---"),console.error("[FATAL ERROR]",o);let e=o instanceof Error?o.message:"An unknown error occurred.";return t.status(500).json({success:!1,message:"뉴스레터 생성에 실패했습니다.",error:e})}}[i,c,E,g]=d.then?(await d)():d,console.log("[CONFIG] 런타임 환경 감지 시작..."),console.log("[CONFIG] FIREBASE_CONFIG:",process.env.FIREBASE_CONFIG?"존재함":"없음"),console.log("[CONFIG] FUNCTION_TARGET:",process.env.FUNCTION_TARGET||"없음"),console.log("[CONFIG] FIREBASE_FUNCTION_URL:",process.env.FIREBASE_FUNCTION_URL||"없음"),console.log("[CONFIG] VERCEL_URL:",process.env.VERCEL_URL||"없음"),r()}catch(e){r(e)}})},7153:(e,t)=>{var o;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return o}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(o||(o={}))},1802:(e,t,o)=>{e.exports=o(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var o=t(t.s=9090);module.exports=o})();